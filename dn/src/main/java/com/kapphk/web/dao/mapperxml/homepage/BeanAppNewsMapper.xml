<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.kapphk.web.dao.mapper.homepage.BeanAppNewsMapper" >
    <resultMap id="BaseResultMap" type="com.kapphk.web.bean.homepage.BeanAppNews" >
        <!--  自动生成 2016年12月22日 表与实体类字段对应 -->
        <id column="id" property="id" jdbcType="BIGINT" />
        <result column="logo_path" property="logoPath" jdbcType="VARCHAR" />
        <result column="title" property="title" jdbcType="VARCHAR" />
        <result column="link" property="link" jdbcType="VARCHAR" />
        <result column="counts" property="counts" jdbcType="INTEGER" />
        <result column="likes" property="likes" jdbcType="INTEGER" />
        <result column="is_top" property="isTop" jdbcType="INTEGER" />
        <result column="is_quality" property="isQuality" jdbcType="INTEGER" />
        <result column="record_type" property="recordType" jdbcType="INTEGER" />
        <result column="news_tag" property="newsTag" jdbcType="VARCHAR" />
        <result column="tag_type" property="tagType" jdbcType="VARCHAR" />
        <result column="is_home" property="isHome" jdbcType="INTEGER" />
        <result column="sort" property="sort" jdbcType="INTEGER" />
        <result column="remark" property="remark" jdbcType="VARCHAR" />
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    </resultMap>
    
    <!-- 资讯赞赏列表  zoneyu 16-11-15 -->
    <select id="getRecord" resultType="java.util.Map">
    	SELECT su.id,su.logo_path AS logoPath 
		FROM sys_user AS su 
		INNER JOIN app_news_order AS ano ON ano.uid = su.id AND ano.news_id = #{id} AND ano.is_pay = 1 
		ORDER BY (CASE WHEN su.id = #{uid} THEN 1 ELSE 0 END) DESC 
    </select>
    
    <!-- 公司公告列表 -->
    <select id="getNoticeList" resultType="java.util.Map">
    	SELECT an.id,an.logo_path AS logoPath, an.title,SUBSTRING(CAST(an.create_time AS CHAR),1,16) AS createTime
		FROM app_news AS an WHERE an.news_tag = #{newsTag} AND an.record_type=5 
		ORDER BY an.id DESC limit #{page},#{rows}
    </select>
    
    <!-- 首页动能资讯  zoneyu 16-10-10 -->
    <select id="findHomeData" resultType="java.util.Map">
    	SELECT an.id,an.logo_path AS logoPath,an.news_tag AS newsTag,an.title,an.counts,
		(SELECT COUNT(1) FROM user_collection WHERE news_id=an.id  AND data_type=2) AS likes,
		(SELECT COUNT(1) FROM user_collection WHERE news_id=an.id  AND data_type=2 AND uid=#{uid}) AS isPoint,
		(SELECT COUNT(1) FROM user_collection WHERE news_id=an.id  AND data_type=1 AND uid=#{uid}) AS isCollect,
		(SELECT COUNT(1) FROM app_news_order WHERE news_id=an.id AND is_pay=1) AS numbers
		FROM app_news AS an WHERE an.is_home = 1 AND an.record_type=3 LIMIT 0,4
    </select>
    
    <!-- 欧巴资讯  zoneyu 16-10-11 -->
    <select id="getList" resultType="java.util.Map">
		SELECT an.id,an.logo_path AS logoPath,an.title,an.counts,CAST(an.create_time AS CHAR) AS createTime,an.news_tag AS newsTag,
		COUNT(uc.id) AS isCollect,COUNT(ucp.id) AS isPoint,an.is_top AS isTop,an.is_quality AS isQuality,
		(SELECT COUNT(1) FROM user_collection WHERE news_id=an.id AND data_type=2) AS likes,
		(SELECT COUNT(1) FROM app_news_order WHERE news_id=an.id AND is_pay=1) AS numbers
		FROM app_news AS an 
		LEFT JOIN user_collection AS uc ON an.id = uc.news_id  AND uc.uid = #{uid} AND uc.data_type = 1 
		LEFT JOIN user_collection AS ucp ON an.id = ucp.news_id AND ucp.uid = #{uid} AND ucp.data_type = 2 
		WHERE an.record_type = #{recordType} 
		GROUP BY an.id ORDER BY an.is_top DESC,an.id DESC 
    	limit #{page},#{rows}
    </select>
    
    <!-- 资讯列表  zoneyu 16-10-9 -->
    <select id="getNewsList" resultType="java.util.Map">
		SELECT n.id,n.title,n.is_top AS isTop,n.news_tag AS newsTag,n.counts AS counts,
		n.logo_path AS logoPath,SUBSTRING(CAST(n.create_time AS CHAR),1,16) AS createTime,
		n.is_quality AS isQuality,COUNT(o.id) AS numbers,
		(SELECT COUNT(1) FROM user_collection WHERE news_id=n.id AND record_type=#{recordType} AND data_type=1 AND uid=#{uid}) AS isCollect,
		(SELECT COUNT(1) FROM user_collection WHERE news_id=n.id AND record_type=#{recordType} AND data_type=2 AND uid=#{uid}) AS isPoint,
		(SELECT COUNT(1) FROM user_collection WHERE news_id=n.id AND record_type=#{recordType} AND data_type=2) AS likes
		FROM app_news n 
		LEFT JOIN app_news_order o on o.news_id=n.id and o.is_pay = 1 
		<where>
			n.record_type=#{recordType}
			<if test="newsTag != null and newsTag != ''">
				AND n.news_tag=#{newsTag}
			</if>
		</where>
		GROUP BY n.id ORDER BY n.is_top DESC,n.sort DESC LIMIT #{page},#{rows}
    </select>
    
    <!-- 获取列表 -->
    <select id="findList" resultType="java.util.Map">
    	SELECT n.id,n.content,n.counts,n.is_home AS isHome,n.is_quality AS isQuality,CAST(n.create_time AS CHAR) AS createTime,n.link,n.sort,
		n.title,n.logo_path AS logoPath,n.likes,n.record_type AS recordType,n.news_tag AS newsTag,n.tag_type AS tagType,n.is_top as isTop 
		FROM app_news n 
		<where >
            <if test="param.title != null and param.title != ''" >
                and n.title like '%${param.title,jdbcType=VARCHAR}%'
            </if>
            <if test="param.isTop != null " >
                and n.is_top = #{param.isTop,jdbcType=INTEGER}
            </if>
            <if test="param.isQuality != null " >
                and n.is_quality = #{param.isQuality,jdbcType=INTEGER}
            </if>
            <if test="param.recordType != null " >
            	and n.record_type = #{param.recordType,jdbcType=INTEGER}
            </if>
            <if test="param.recordType == null and param.state == 1" >
                and (n.record_type = 1 or n.record_type = 2)
            </if>
            <if test="param.newsTag != null and param.newsTag != ''" >
                and n.news_tag = #{param.newsTag,jdbcType=VARCHAR}
            </if>
        </where>
		ORDER BY n.create_time DESC LIMIT #{page},#{rows}
    </select>
    
    <!-- 获取列表总数-->
    <select id="findCount" resultType="java.lang.Integer">
    	SELECT COUNT(1)
		FROM app_news n 
		<where >
            <if test="param.title != null and param.title != ''" >
                and n.title like '%${param.title,jdbcType=VARCHAR}%'
            </if>
            <if test="param.isTop != null " >
                and n.is_top = #{param.isTop,jdbcType=INTEGER}
            </if>
            <if test="param.isQuality != null " >
                and n.is_quality = #{param.isQuality,jdbcType=INTEGER}
            </if>
             <if test="param.recordType != null " >
            	and n.record_type = #{param.recordType,jdbcType=INTEGER}
            </if>
            <if test="param.recordType == null and param.state == 1" >
                and (n.record_type = 1 or n.record_type = 2)
            </if>
            <if test="param.newsTag != null and param.newsTag != ''" >
                and n.news_tag = #{param.newsTag,jdbcType=VARCHAR}
            </if>
        </where>
    </select>
    
    <!-- 更新之前置顶 -->
    <update id="upIsTop">
    	<if test="param.recordType == 1 or param.recordType == 2">
    		UPDATE app_news SET is_top = 0 WHERE is_top = 1 AND (record_type = 1 or record_type = 2)
    	</if>
    	<if test="param.recordType == 6">
    		UPDATE app_news SET is_top = 0 WHERE record_type = #{param.recordType} AND is_top = 1 
    	</if>
    	<if test="param.recordType == 3">
    		UPDATE app_news SET is_top = 0 WHERE is_top = 1 AND record_type = #{param.recordType} AND news_tag = #{param.newsTag}
    	</if>
    </update>
    
    <resultMap id="ResultMapWithBLOBs" type="com.kapphk.web.bean.homepage.BeanAppNews" extends="BaseResultMap" >
        <!--  自动生成 2016年12月22日 表与实体类字段对应 -->
        <result column="content" property="content" jdbcType="LONGVARCHAR" />
    </resultMap>
    
    <sql id="Base_Column_List" >
        <!--  自动生成 2016年12月22日 表字段名称 -->
        id, logo_path, title, link, counts, likes, is_top, is_quality, record_type, news_tag, 
        tag_type, is_home, sort, remark, create_time
    </sql>
    
    <sql id="Blob_Column_List" >
        <!--  自动生成 2016年12月22日 表字段名称 -->
        content
    </sql>
    
    <sql id="findByPageSql" >
        <!-- WARNING -  自动生成 2016-12-22  分页查询SQL -->
        select a.* from app_news a
        <where >
            <if test="param.id != null " >
                and a.id = #{param.id,jdbcType=BIGINT}
            </if>
            <if test="param.logoPath != null and param.logoPath != ''" >
                and a.logo_path = #{param.logoPath,jdbcType=VARCHAR}
            </if>
            <if test="param.title != null and param.title != ''" >
                and a.title = #{param.title,jdbcType=VARCHAR}
            </if>
            <if test="param.link != null and param.link != ''" >
                and a.link = #{param.link,jdbcType=VARCHAR}
            </if>
            <if test="param.counts != null " >
                and a.counts = #{param.counts,jdbcType=INTEGER}
            </if>
            <if test="param.likes != null " >
                and a.likes = #{param.likes,jdbcType=INTEGER}
            </if>
            <if test="param.isTop != null " >
                and a.is_top = #{param.isTop,jdbcType=INTEGER}
            </if>
            <if test="param.isQuality != null " >
                and a.is_quality = #{param.isQuality,jdbcType=INTEGER}
            </if>
            <if test="param.recordType != null " >
                and a.record_type = #{param.recordType,jdbcType=INTEGER}
            </if>
            <if test="param.newsTag != null and param.newsTag != ''" >
                and a.news_tag = #{param.newsTag,jdbcType=VARCHAR}
            </if>
            <if test="param.tagType != null and param.tagType != ''" >
                and a.tag_type = #{param.tagType,jdbcType=VARCHAR}
            </if>
            <if test="param.isHome != null " >
                and a.is_home = #{param.isHome,jdbcType=INTEGER}
            </if>
            <if test="param.sort != null " >
                and a.sort = #{param.sort,jdbcType=INTEGER}
            </if>
            <if test="param.remark != null and param.remark != ''" >
                and a.remark = #{param.remark,jdbcType=VARCHAR}
            </if>
            <if test="param.content != null " >
                and a.content = #{param.content,jdbcType=LONGVARCHAR}
            </if>
        </where>
        order by a.id desc
    </sql>
    
    <select id="findByPage" resultMap="BaseResultMap" >
        <!-- WARNING -  自动生成 2016-12-22  分页查询 -->
        select temp.* from (
        <include refid="findByPageSql" />
        ) temp limit #{offset}, #{pageSize}
    </select>
    
    <select id="findByPageCount" resultType="java.lang.Integer" >
        <!-- WARNING -  自动生成 2016-12-22  分页查询总条数 -->
        select count(1) from (
        <include refid="findByPageSql" />
        ) temp 
    </select>
    
    <select id="findById" resultMap="ResultMapWithBLOBs" parameterType="java.lang.Long" >
        <!--  自动生成 2016年12月22日 根据ID查询 -->
        select 
        <include refid="Base_Column_List" />
        ,
        <include refid="Blob_Column_List" />
        from app_news
        where id = #{id,jdbcType=BIGINT}
    </select>
    
    <select id="load" resultMap="BaseResultMap" >
        <!-- WARNING -  自动生成 2016-12-22  根据多个ID查询 -->
        select 
        <include refid="Base_Column_List" />
        from app_news where id in 
        <foreach collection="ids" item="item" open="(" separator="," close=")" >
            #{item}
        </foreach>
    </select>
    
    <select id="all" resultMap="BaseResultMap" >
        <!-- WARNING -  自动生成 2016-12-22  查询所有 -->
        select 
        <include refid="Base_Column_List" />
        from app_news
    </select>
    
    <select id="count" resultType="java.lang.Integer" >
        <!-- WARNING -  自动生成 2016-12-22 查询总条数 -->
        select count(1) from app_news
    </select>
    
    <update id="update" parameterType="com.kapphk.web.bean.homepage.BeanAppNews" >
        <!--  自动生成 2016年12月22日 更新数据 -->
        update app_news
        <set >
            <if test="logoPath != null" >
                logo_path = #{logoPath,jdbcType=VARCHAR},
            </if>
            <if test="title != null" >
                title = #{title,jdbcType=VARCHAR},
            </if>
            <if test="link != null" >
                link = #{link,jdbcType=VARCHAR},
            </if>
            <if test="counts != null" >
                counts = #{counts,jdbcType=INTEGER},
            </if>
            <if test="likes != null" >
                likes = #{likes,jdbcType=INTEGER},
            </if>
            <if test="isTop != null" >
                is_top = #{isTop,jdbcType=INTEGER},
            </if>
            <if test="isQuality != null" >
                is_quality = #{isQuality,jdbcType=INTEGER},
            </if>
            <if test="recordType != null" >
                record_type = #{recordType,jdbcType=INTEGER},
            </if>
            <if test="newsTag != null" >
                news_tag = #{newsTag,jdbcType=VARCHAR},
            </if>
            <if test="tagType != null" >
                tag_type = #{tagType,jdbcType=VARCHAR},
            </if>
            <if test="isHome != null" >
                is_home = #{isHome,jdbcType=INTEGER},
            </if>
            <if test="sort != null" >
                sort = #{sort,jdbcType=INTEGER},
            </if>
            <if test="remark != null" >
                remark = #{remark,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null" >
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="content != null" >
                content = #{content,jdbcType=LONGVARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
    </update>
    
    <insert id="insert" parameterType="com.kapphk.web.bean.homepage.BeanAppNews" useGeneratedKeys="true" keyProperty="id" >
        <!--  自动生成 2016年12月22日 添加数据 -->
        insert into app_news
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="logoPath != null" >
                logo_path,
            </if>
            <if test="title != null" >
                title,
            </if>
            <if test="link != null" >
                link,
            </if>
            <if test="counts != null" >
                counts,
            </if>
            <if test="likes != null" >
                likes,
            </if>
            <if test="isTop != null" >
                is_top,
            </if>
            <if test="isQuality != null" >
                is_quality,
            </if>
            <if test="recordType != null" >
                record_type,
            </if>
            <if test="newsTag != null" >
                news_tag,
            </if>
            <if test="tagType != null" >
                tag_type,
            </if>
            <if test="isHome != null" >
                is_home,
            </if>
            <if test="sort != null" >
                sort,
            </if>
            <if test="remark != null" >
                remark,
            </if>
            <if test="createTime != null" >
                create_time,
            </if>
            <if test="content != null" >
                content,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="logoPath != null" >
                #{logoPath,jdbcType=VARCHAR},
            </if>
            <if test="title != null" >
                #{title,jdbcType=VARCHAR},
            </if>
            <if test="link != null" >
                #{link,jdbcType=VARCHAR},
            </if>
            <if test="counts != null" >
                #{counts,jdbcType=INTEGER},
            </if>
            <if test="likes != null" >
                #{likes,jdbcType=INTEGER},
            </if>
            <if test="isTop != null" >
                #{isTop,jdbcType=INTEGER},
            </if>
            <if test="isQuality != null" >
                #{isQuality,jdbcType=INTEGER},
            </if>
            <if test="recordType != null" >
                #{recordType,jdbcType=INTEGER},
            </if>
            <if test="newsTag != null" >
                #{newsTag,jdbcType=VARCHAR},
            </if>
            <if test="tagType != null" >
                #{tagType,jdbcType=VARCHAR},
            </if>
            <if test="isHome != null" >
                #{isHome,jdbcType=INTEGER},
            </if>
            <if test="sort != null" >
                #{sort,jdbcType=INTEGER},
            </if>
            <if test="remark != null" >
                #{remark,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null" >
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="content != null" >
                #{content,jdbcType=LONGVARCHAR},
            </if>
        </trim>
    </insert>
    
    <delete id="delete" parameterType="java.lang.Long" >
        <!--  自动生成 2016年12月22日 删除数据 -->
        delete from app_news
        where id = #{id,jdbcType=BIGINT}
    </delete>
    
    <update id="updateByPrimaryKeyWithBLOBs" parameterType="com.kapphk.web.bean.homepage.BeanAppNews" >
        <!--  自动生成 2016年12月22日 更新数据 -->
        update app_news
        set logo_path = #{logoPath,jdbcType=VARCHAR},
            title = #{title,jdbcType=VARCHAR},
            link = #{link,jdbcType=VARCHAR},
            counts = #{counts,jdbcType=INTEGER},
            likes = #{likes,jdbcType=INTEGER},
            is_top = #{isTop,jdbcType=INTEGER},
            is_quality = #{isQuality,jdbcType=INTEGER},
            record_type = #{recordType,jdbcType=INTEGER},
            news_tag = #{newsTag,jdbcType=VARCHAR},
            tag_type = #{tagType,jdbcType=VARCHAR},
            is_home = #{isHome,jdbcType=INTEGER},
            sort = #{sort,jdbcType=INTEGER},
            remark = #{remark,jdbcType=VARCHAR},
            create_time = #{createTime,jdbcType=TIMESTAMP},
            content = #{content,jdbcType=LONGVARCHAR}
        where id = #{id,jdbcType=BIGINT}
    </update>
    
    <insert id="inserts" parameterType="java.util.List" >
        <!-- WARNING -  自动生成 2016-12-22 添加多条数据 -->
        insert into app_news (logo_path, title, link, counts, likes, is_top, is_quality, record_type, news_tag, tag_type, is_home, sort, remark, create_time, content)
        values
        <foreach collection="list" item="item" separator="," >
            (#{item.logoPath,jdbcType=VARCHAR}, #{item.title,jdbcType=VARCHAR}, #{item.link,jdbcType=VARCHAR}, #{item.counts,jdbcType=INTEGER}, #{item.likes,jdbcType=INTEGER}, #{item.isTop,jdbcType=INTEGER}, #{item.isQuality,jdbcType=INTEGER}, #{item.recordType,jdbcType=INTEGER}, #{item.newsTag,jdbcType=VARCHAR}, #{item.tagType,jdbcType=VARCHAR}, #{item.isHome,jdbcType=INTEGER}, #{item.sort,jdbcType=INTEGER}, #{item.remark,jdbcType=VARCHAR}, #{item.createTime,jdbcType=TIMESTAMP}, #{item.content,jdbcType=LONGVARCHAR})
        </foreach>
    </insert>
    
    <delete id="deletes" >
        <!-- WARNING -  自动生成 2016-12-22 删除多条数据 -->
        delete from app_news where id in 
        <foreach collection="ids" item="item" open="(" separator="," close=")" >
            #{item}
        </foreach>
    </delete>
    
    <delete id="deleteByEntity" >
        <!-- WARNING -  自动生成 2016-12-22 通过实体类中的条件删除数据 -->
        delete from app_news
        <where >
            <if test="param.id != null " >
                and id = #{param.id,jdbcType=BIGINT}
            </if>
            <if test="param.logoPath != null and param.logoPath != ''" >
                and logo_path = #{param.logoPath,jdbcType=VARCHAR}
            </if>
            <if test="param.title != null and param.title != ''" >
                and title = #{param.title,jdbcType=VARCHAR}
            </if>
            <if test="param.link != null and param.link != ''" >
                and link = #{param.link,jdbcType=VARCHAR}
            </if>
            <if test="param.counts != null " >
                and counts = #{param.counts,jdbcType=INTEGER}
            </if>
            <if test="param.likes != null " >
                and likes = #{param.likes,jdbcType=INTEGER}
            </if>
            <if test="param.isTop != null " >
                and is_top = #{param.isTop,jdbcType=INTEGER}
            </if>
            <if test="param.isQuality != null " >
                and is_quality = #{param.isQuality,jdbcType=INTEGER}
            </if>
            <if test="param.recordType != null " >
                and record_type = #{param.recordType,jdbcType=INTEGER}
            </if>
            <if test="param.newsTag != null and param.newsTag != ''" >
                and news_tag = #{param.newsTag,jdbcType=VARCHAR}
            </if>
            <if test="param.tagType != null and param.tagType != ''" >
                and tag_type = #{param.tagType,jdbcType=VARCHAR}
            </if>
            <if test="param.isHome != null " >
                and is_home = #{param.isHome,jdbcType=INTEGER}
            </if>
            <if test="param.sort != null " >
                and sort = #{param.sort,jdbcType=INTEGER}
            </if>
            <if test="param.remark != null and param.remark != ''" >
                and remark = #{param.remark,jdbcType=VARCHAR}
            </if>
            <if test="param.content != null " >
                and content = #{param.content,jdbcType=LONGVARCHAR}
            </if>
        </where>
    </delete>
    
    <select id="findAll" resultMap="BaseResultMap" >
        <!-- WARNING -  自动生成 2016-12-22  通过实体中的条件查询所有 -->
        select temp.* from (
        <include refid="findByPageSql" />
        ) temp 
    </select>
    
    <select id="findEntityByCondition" resultMap="BaseResultMap" >
        <!-- WARNING -  自动生成 2016-12-22  通过实体中的条件查询所有 -->
        select temp.* from (
        <include refid="findByPageSql" />
        ) temp limit 0,1
    </select>
</mapper>